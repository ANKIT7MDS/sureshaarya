<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Karyakram Dashboard ‚Äì FINAL</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- LIBRARIES -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0b0c10;color:#fff}
button{padding:10px 15px;margin:5px;cursor:pointer}
.slide{
  width:1200px;height:800px;
  background:#0b0c10;
  padding:30px;
  display:flex;
  gap:20px;
}
.info{
  flex:1;
  background:#1f2833;
  padding:30px;
  border-radius:15px;
}
.photos{
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr;
  grid-template-rows:1fr 1fr;
  gap:15px;
}
.photo{
  border:2px solid #45a29e;
  border-radius:10px;
  overflow:hidden;
  background:#000;
}
.photo img{
  width:100%;
  height:100%;
  object-fit:cover;
}
</style>
</head>

<body>

<button onclick="downloadImage()">‚¨áÔ∏è Image</button>
<button onclick="downloadPDF()">‚¨áÔ∏è PDF</button>
<button onclick="downloadPPT()">‚¨áÔ∏è PPT</button>

<div id="slide" class="slide"></div>

<script>
/* ================== GOOGLE SHEET CONFIG ================== */
const SHEET_ID = "1wyr0gt061UT5IVxT1JBYUEUJw1GYcBpzxDKEQmvcXXY";
const GID = "1839722438";
const SHEET_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${GID}`;

/* ================== HELPERS ================== */
function extractDriveId(text){
  if(!text) return null;
  let m=text.match(/\/file\/d\/([\w-]+)/);
  if(m) return m[1];
  m=text.match(/[?&]id=([\w-]+)/);
  if(m) return m[1];
  if(/^[\w-]{25,}$/.test(text)) return text;
  return null;
}

function driveImageUrl(id){
  return `https://lh3.googleusercontent.com/d/${id}=w1200`;
}

async function waitForImages(el){
  const imgs=el.querySelectorAll("img");
  await Promise.all([...imgs].map(img=>{
    if(img.complete) return;
    return new Promise(r=>img.onload=img.onerror=r);
  }));
}

/* ================== LOAD DATA ================== */
let currentData=null;

fetch(SHEET_URL)
.then(r=>r.text())
.then(t=>{
  const json=JSON.parse(t.substring(47).slice(0,-2));
  const row=json.table.rows[0].c;

  const event=row[3]?.v || "‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ";
  const date=row[1]?.v || "";
  const district=row[2]?.v || "";
  const guests=row[5]?.v || "";

  let photos=[];
  for(let i=6;i<row.length;i++){
    const id=extractDriveId(row[i]?.v);
    if(id) photos.push(id);
  }

  currentData={event,date,district,guests,photos};
  renderSlide();
});

/* ================== RENDER ================== */
function renderSlide(){
  const s=document.getElementById("slide");
  const d=currentData;

  s.innerHTML=`
    <div class="info">
      <h1 style="color:#66fcf1">${d.event}</h1>
      <p>üìÖ ${d.date}</p>
      <p>üìç ${d.district}</p>
      <p>üé§ ${d.guests}</p>
    </div>
    <div class="photos">
      ${[0,1,2,3].map(i=>{
        if(d.photos[i]){
          return `<div class="photo">
            <img crossorigin="anonymous"
             src="${driveImageUrl(d.photos[i])}">
          </div>`;
        }
        return `<div class="photo"></div>`;
      }).join("")}
    </div>
  `;
}

/* ================== DOWNLOAD IMAGE ================== */
async function downloadImage(){
  const el=document.getElementById("slide");
  await waitForImages(el);

  const canvas=await html2canvas(el,{
    scale:2,
    useCORS:true,
    allowTaint:false,
    backgroundColor:"#0b0c10"
  });

  const a=document.createElement("a");
  a.download="karyakram.png";
  a.href=canvas.toDataURL("image/png");
  a.click();
}

/* ================== DOWNLOAD PDF ================== */
async function downloadPDF(){
  const el=document.getElementById("slide");
  await waitForImages(el);

  html2pdf().set({
    filename:"karyakram.pdf",
    margin:0,
    html2canvas:{
      scale:2,
      useCORS:true,
      allowTaint:false,
      backgroundColor:"#0b0c10"
    },
    jsPDF:{unit:"px",format:[1200,800],orientation:"landscape"}
  }).from(el).save();
}

/* ================== DOWNLOAD PPT ================== */
async function downloadPPT(){
  const ppt=new PptxGenJS();
  ppt.layout="LAYOUT_WIDE";
  const slide=ppt.addSlide();

  slide.addText(currentData.event,{
    x:0.5,y:0.5,fontSize:24,color:"66fcf1"
  });

  currentData.photos.slice(0,4).forEach((id,i)=>{
    slide.addImage({
      path:driveImageUrl(id),
      x:i%2?6:3,
      y:i<2?1.5:3.5,
      w:2.3,h:1.8
    });
  });

  ppt.writeFile({fileName:"karyakram.pptx"});
}
</script>
</body>
</html>
