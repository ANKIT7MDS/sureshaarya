<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‚Äì ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° (Google Sheet)</title>

<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&family=Hind:wght@400;600&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:"Noto Sans Devanagari","Hind",system-ui;background:#f7f8fb;color:#1b2941}
.wrap{max-width:1200px;margin:auto;padding:16px}
.topbar,.filters{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between;margin-bottom:10px}
.btn{border:1px solid #1f3b73;background:#eef3ff;color:#1f3b73;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
.btn:hover{background:#1f3b73;color:#fff}
.page{background:#fff;border:1px solid #e8e9ee;border-radius:16px;box-shadow:0 6px 18px rgba(0,0,0,.05);padding:20px}
.header{display:grid;grid-template-columns:80px 1fr 100px;gap:15px;align-items:center;border-bottom:4px solid #e77019;padding-bottom:15px;margin-bottom:20px}
.logo{width:80px;height:80px;border-radius:50%;background:#ffe7d6;border:2px solid #e77019;display:flex;align-items:center;justify-content:center;font-weight:800}
.content{display:grid;grid-template-columns:1fr 1.2fr;gap:20px}
.card-info,.card-gallery{border:1px solid #e8e9ee;border-radius:14px;padding:20px}
.section-title{margin:0 0 15px;border-left:5px solid #e77019;padding-left:10px}
dl{margin:0;display:grid;grid-template-columns:140px 1fr;row-gap:12px}
.highlight-val{color:#e77019;font-weight:700;font-size:1.2rem}
.gallery-container{border:1px solid #eee;border-radius:8px;min-height:350px;overflow:hidden;position:relative}
.drive-frame{width:100%;height:100%;border:0;position:absolute;top:0;left:0}
.fallback-btn{display:inline-block;background:#e77019;color:#fff;padding:10px 22px;border-radius:6px;text-decoration:none;font-weight:700;margin-top:10px}
@media(max-width:768px){.content{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="wrap">

<div class="topbar">
  <div>
    <button class="btn" id="prev">‚óÄÔ∏é ‡§™‡§ø‡§õ‡§≤‡§æ</button>
    <button class="btn" id="next">‡§Ö‡§ó‡§≤‡§æ ‚ñ∂Ô∏é</button>
    <select id="jump"></select>
  </div>
  <input id="search" type="search" placeholder="üîç ‡§ñ‡•ã‡§ú‡•á‡§Ç (‡§®‡§æ‡§Æ/‡§∏‡•ç‡§•‡§æ‡§®/‡§Ö‡§§‡§ø‡§•‡§ø)">
</div>

<div class="filters">
  <select id="fDistrict"><option value="">üìç ‡§∏‡§≠‡•Ä ‡§ú‡§ø‡§≤‡•á</option></select>
  <span id="status">Loading...</span>
</div>

<div id="page" class="page">
  <div style="text-align:center;padding:50px">‚è≥ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
</div>

</div>

<script>
/* ================= CONFIG ================= */

const SHEET_ID = "1wyr0gt061UT5IVxT1JBYUEUJw1GYcBpzxDKEQmvcXXY";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
const PROXY_URL = "https://corsproxy.io/?" + encodeURIComponent(SHEET_URL);

/* ================= STATE ================= */

let rawData=[], filtered=[], idx=0;

/* ================= ELEMENTS ================= */

const pageEl=document.getElementById("page");
const prevBtn=document.getElementById("prev");
const nextBtn=document.getElementById("next");
const jumpSel=document.getElementById("jump");
const search=document.getElementById("search");
const fDistrict=document.getElementById("fDistrict");
const statusEl=document.getElementById("status");

/* ================= HELPERS ================= */

function getDriveId(url){
  if(!url) return null;
  const m=url.match(/[-\w]{25,}/);
  return m?m[0]:null;
}

function parseCSV(text){
  return text.trim().split("\n").map(r=>r.split(","));
}

/* ================= FETCH DATA ================= */

async function fetchData(){
  try{
    let res=await fetch(SHEET_URL);
    if(!res.ok) res=await fetch(PROXY_URL);
    const txt=await res.text();
    const rows=parseCSV(txt);

    rows.slice(1).forEach(r=>{
      rawData.push({
        date:r[0]||"",
        district:r[1]||"",
        title:r[2]||"‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ",
        count:r[3]||"0",
        guests:r[4]||"-",
        link:r[5]||""
      });
    });

    initUI();
  }catch(e){
    pageEl.innerHTML="<h2 style='color:red'>‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§®‡§π‡•Ä‡§Ç ‡§π‡•ã ‡§∏‡§ï‡§æ</h2>";
    statusEl.textContent="Error";
  }
}

/* ================= RENDER ================= */

function render(){
  if(!filtered.length){
    pageEl.innerHTML="‡§ï‡•ã‡§à ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ";
    return;
  }

  const it=filtered[idx];
  const id=getDriveId(it.link);
  const embed=id?`https://drive.google.com/drive/folders/${id}?usp=sharing`:"";

  pageEl.innerHTML=`
  <div class="header">
    <div class="logo">Visit</div>
    <div>
      <h2>${it.title}</h2>
      üìç ${it.district} ‚Ä¢ üìÖ ${it.date}
    </div>
    <div>${idx+1}/${filtered.length}</div>
  </div>

  <div class="content">
    <div class="card-info">
      <h3 class="section-title">‡§µ‡§ø‡§µ‡§∞‡§£</h3>
      <dl>
        <dt>‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</dt><dd class="highlight-val">${it.count}</dd>
        <dt>‡§Ö‡§§‡§ø‡§•‡§ø</dt><dd>${it.guests}</dd>
      </dl>
    </div>

    <div class="card-gallery">
      <h3 class="section-title">‡§´‡•ã‡§ü‡•ã ‡§è‡§≤‡•ç‡§¨‡§Æ</h3>
      <div class="gallery-container">
        ${id?`<iframe class="drive-frame" src="${embed}" loading="lazy"></iframe>`:"Preview Not Available"}
      </div>
      <a class="fallback-btn" target="_blank" href="${it.link}">üìÇ Open Gallery</a>
    </div>
  </div>`;
}

/* ================= LOGIC ================= */

function apply(){
  const s=search.value.toLowerCase();
  filtered=rawData.filter(i=>(i.title+i.district+i.guests).toLowerCase().includes(s));

  jumpSel.innerHTML="";
  filtered.forEach((_,i)=>jumpSel.add(new Option(i+1,i)));

  idx=0;
  render();
}

function initUI(){
  [...new Set(rawData.map(i=>i.district))].filter(Boolean)
    .forEach(d=>fDistrict.add(new Option(d,d)));

  apply();
}

/* ================= EVENTS ================= */

prevBtn.onclick=()=>{if(idx>0){idx--;render()}};
nextBtn.onclick=()=>{if(idx<filtered.length-1){idx++;render()}};
jumpSel.onchange=e=>{idx=+e.target.value;render()};
search.oninput=apply;
fDistrict.onchange=apply;

/* ================= INIT ================= */

fetchData();
</script>
</body>
</html>
