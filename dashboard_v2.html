<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‚Äì ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§° (Final Version)</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600;700&family=Hind:wght@400;600&display=swap" rel="stylesheet">
<style>
/* --- Theme Styles --- */
body { margin:0; font-family:"Noto Sans Devanagari","Hind",system-ui,Arial,sans-serif; background:#f7f8fb; color:#1b2941; }
.wrap { max-width:1200px; margin:0 auto; padding:16px; }

/* Top Bar */
.topbar, .filters { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom: 15px; }
.btn { border:1px solid #1f3b73; background:#eef3ff; color:#1f3b73; padding:8px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition:0.2s; }
.btn:hover { background: #1f3b73; color: white; }
.btn:disabled { opacity:0.5; cursor:not-allowed; }

/* Inputs */
input, select { padding:10px; border:1px solid #d6d9e0; border-radius:8px; background:#fff; font-family:inherit; font-size:14px; }
.search-box { flex-grow: 1; max-width: 300px; }

/* Main Card */
.page { background:#fff; border:1px solid #e8e9ee; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.06); padding:25px; min-height: 550px; }

.header { display:flex; justify-content:space-between; align-items:center; border-bottom:4px solid #e77019; padding-bottom:15px; margin-bottom: 25px; flex-wrap:wrap; gap:15px; }
.header-left { display:flex; align-items:center; gap:15px; }
.logo { width:60px; height:60px; border-radius:50%; background:#fff; border:2px solid #e77019; display:flex; align-items:center; justify-content:center; font-size:24px; }
.title h1 { margin:0; color:#183566; font-size:24px; line-height:1.2; }
.subtitle { color:#5c6a86; margin-top:5px; font-weight:500; font-size:14px; }
.meta { font-weight:700; color:#e77019; background:#fff5eb; padding:5px 10px; border-radius:6px; }

.content { display:grid; grid-template-columns:1fr 1.4fr; gap:30px; }

/* Info Section */
.card-info { background:#f8f9fa; border-radius:12px; padding:20px; border:1px solid #eee; }
.section-title { margin:0 0 15px; color:#183566; font-size:16px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; border-bottom:1px solid #ddd; padding-bottom:5px; }
dl { display:grid; grid-template-columns:100px 1fr; row-gap:15px; margin:0; }
dt { color:#666; font-size:14px; font-weight:600; } 
dd { margin:0; font-weight:500; color:#333; font-size:15px; }
.highlight-val { color:#e77019; font-weight:800; font-size:18px; }

/* Gallery Section */
.card-gallery { display:flex; flex-direction:column; gap:10px; }
.gallery-container { 
    flex-grow:1; border-radius:12px; overflow:hidden; border:1px solid #ddd; 
    background:#fafafa; position:relative; min-height:400px; 
    display:flex; justify-content:center; align-items:center; 
}

/* --- THE MAGIC LAYERS --- */

/* 1. IFRAME (Grid View) - Always there at bottom */
.drive-frame { 
    width:100%; height:100%; border:0; position:absolute; inset:0; z-index:1; 
    background:#fff; 
}

/* 2. IMAGE (Thumbnail) - On top. Hides if broken. */
.direct-img { 
    width:100%; height:100%; object-fit:contain; position:absolute; inset:0; z-index:2; 
    background:#fff; transition: opacity 0.3s;
}

/* 3. Placeholder (Behind everything) */
.placeholder { position:absolute; z-index:0; color:#999; text-align:center; }

.fallback-btn { 
    display:block; text-align:center; background:#e77019; color:white; 
    padding:12px; border-radius:8px; text-decoration:none; font-weight:bold; 
    box-shadow:0 4px 10px rgba(231,112,25,0.2); transition:0.2s;
}
.fallback-btn:hover { background:#d35400; transform:translateY(-2px); }

/* Print View */
#print-view { display:none; }
@media print {
    body, .wrap { background:white; padding:0; margin:0; max-width:100%; }
    .topbar, .filters, .page { display:none !important; }
    #print-view { display:block !important; padding:20px; }
    .p-card { border:1px solid #ccc; padding:15px; margin-bottom:20px; page-break-inside:avoid; display:flex; gap:20px; }
    .p-img { width:150px; height:150px; object-fit:cover; border:1px solid #eee; }
}

@media (max-width: 768px) { .content { grid-template-columns:1fr; } .gallery-container { min-height:300px; } }
</style>
</head>
<body>

<div class="wrap">
  <!-- Controls -->
  <div class="topbar">
    <div>
      <button class="btn" id="prev">‚óÄÔ∏é ‡§™‡§ø‡§õ‡§≤‡§æ</button>
      <button class="btn" id="next">‡§Ö‡§ó‡§≤‡§æ ‚ñ∂Ô∏é</button>
      <select id="jump" style="width:60px"></select>
    </div>
    <div style="flex-grow:1; display:flex; gap:10px; justify-content:flex-end;">
      <input id="search" class="search-box" type="search" placeholder="üîç ‡§ñ‡•ã‡§ú‡•á‡§Ç..." />
      <button class="btn" onclick="printAllData()" style="background:#e77019; color:white;">üñ®Ô∏è PDF ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <select id="fDistrict" style="min-width:150px"><option value="">üìç ‡§∏‡§≠‡•Ä ‡§ú‡§ø‡§≤‡•á (All)</option></select>
    <input type="date" id="fDate">
    <span id="status" style="font-size:14px; color:#666; margin-left:auto;">Loading...</span>
  </div>

  <!-- Main Slide -->
  <div id="page" class="page">
    <div style="height:400px; display:flex; justify-content:center; align-items:center; color:#666;">
        <h2>‚è≥ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</h2>
    </div>
  </div>
</div>

<!-- Print Container -->
<div id="print-view"></div>

<script>
    // --- Config ---
    const SHEET_ID = "1wyr0gt061UT5IVxT1JBYUEUJw1GYcBpzxDKEQmvcXXY";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
    const PROXY_URL = "https://corsproxy.io/?" + encodeURIComponent(CSV_URL);

    let rawData = [], filtered = [], idx = 0;

    const els = {
        page: document.getElementById('page'),
        status: document.getElementById('status'),
        prev: document.getElementById('prev'),
        next: document.getElementById('next'),
        jump: document.getElementById('jump'),
        search: document.getElementById('search'),
        dist: document.getElementById('fDistrict'),
        date: document.getElementById('fDate'),
        print: document.getElementById('print-view')
    };

    // --- Helpers ---
    function parseDate(d) {
        if(!d) return new Date(0);
        const p = d.trim().split(/[/\-\.]/);
        return p.length===3 ? new Date(p[2], p[1]-1, p[0]) : new Date(d);
    }

    function parseCSV(text) {
        const r = []; let row = [], c = "", q = false;
        for (let i = 0; i < text.length; i++) {
            let ch = text[i];
            if (q) { if (ch === '"' && text[i+1] === '"') { c += '"'; i++; } else if (ch === '"') q = false; else c += ch; }
            else { if (ch === '"') q = true; else if (ch === ',') { row.push(c.trim()); c = ""; } else if (ch === '\n' || ch === '\r') { row.push(c.trim()); if(row.length) r.push(row); row = []; c = ""; } else c += ch; }
        }
        if (c || row.length) { row.push(c.trim()); r.push(row); }
        return r;
    }

    async function fetchData() {
        try {
            els.status.textContent = "Connecting...";
            let res = await fetch(CSV_URL);
            if (!res.ok) res = await fetch(PROXY_URL);
            if (!res.ok) throw new Error("Connection Failed");
            
            const text = await res.text();
            if(text.includes("<!DOCTYPE html")) throw new Error("Access Denied");

            const rows = parseCSV(text);
            const headers = rows[0].map(h => h.toLowerCase());
            const data = rows.slice(1);

            const getIdx = (k) => headers.findIndex(h => k.some(w => h.includes(w)));
            const iDate = getIdx(['date','‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï','‡§§‡§æ‡§∞‡•Ä‡§ñ']);
            const iDist = getIdx(['district','place','‡§ú‡§ø‡§≤‡§æ']);
            const iTitle = getIdx(['title','event','‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ']);
            const iCount = getIdx(['count','attendance','‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ']);
            const iGuest = getIdx(['guest','chief','‡§Ö‡§§‡§ø‡§•‡§ø']);
            const iLink = getIdx(['link','url','photo']);

            rawData = data.map(r => ({
                date: r[iDate]||"", district: r[iDist]||"", title: r[iTitle]||"Unknown",
                count: r[iCount]||"0", guests: r[iGuest]||"-", link: r[iLink]||""
            })).filter(i => i.title && i.date);

            rawData.sort((a,b) => parseDate(b.date) - parseDate(a.date));
            
            initUI();
            els.status.textContent = `‡§ï‡•Å‡§≤: ${rawData.length} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏`;
        } catch (e) {
            els.page.innerHTML = `<div style="text-align:center;padding:50px;color:red"><h3>Error</h3><p>${e.message}</p></div>`;
        }
    }

    function getDriveId(url) {
        if (!url) return null;
        const parts = url.split(/\/d\/|id=|folders\//);
        return parts.length > 1 ? parts[1].split(/[/?&]/)[0] : null;
    }

    // --- RENDER ---
    function renderCurrent() {
        if (!filtered.length) { els.page.innerHTML = `<div style="text-align:center;padding:50px">‡§ï‡•ã‡§à ‡§°‡•á‡§ü‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</div>`; return; }
        
        const item = filtered[idx];
        const driveId = getDriveId(item.link);
        const cleanLink = item.link.match(/https?:\/\/[^\s,]+/)?.[0] || item.link;

        // URLs
        const folderUrl = driveId ? `https://drive.google.com/embeddedfolderview?id=${driveId}#grid` : "";
        const imgUrl = driveId ? `https://lh3.googleusercontent.com/d/${driveId}=w800` : "";

        els.page.innerHTML = `
            <div class="header">
                <div class="header-left">
                    <div class="logo">üö©</div>
                    <div>
                        <h1 class="title">${item.title}</h1>
                        <div class="subtitle">üìç ${item.district} ‚Ä¢ üìÖ ${item.date}</div>
                    </div>
                </div>
                <div class="meta">${idx+1} / ${filtered.length}</div>
            </div>

            <div class="content">
                <div class="card-info">
                    <h3 class="section-title">‡§µ‡§ø‡§µ‡§∞‡§£</h3>
                    <dl>
                        <dt>üìÖ ‡§§‡§æ‡§∞‡•Ä‡§ñ</dt><dd>${item.date}</dd>
                        <dt>üìç ‡§ú‡§ø‡§≤‡§æ</dt><dd>${item.district}</dd>
                        <dt>üë• ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø</dt><dd class="highlight-val">${item.count}</dd>
                        <dt>üé§ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§Ö‡§§‡§ø‡§•‡§ø</dt><dd>${item.guests}</dd>
                    </dl>
                </div>

                <div class="card-gallery">
                    <div class="gallery-container">
                        <!-- LAYER 1: IFRAME (FOLDER GRID) -->
                        <iframe src="${folderUrl}" class="drive-frame" title="Folder View" allowfullscreen="true"></iframe>
                        
                        <!-- LAYER 2: IMAGE (Tries to load on top) -->
                        <img src="${imgUrl}" class="direct-img" alt="" onerror="this.style.display='none'">
                        
                        <!-- LAYER 3: Placeholder -->
                        <div class="placeholder">üì∏ ‡§´‡•ã‡§ü‡•ã ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
                    </div>
                    <a href="${cleanLink}" target="_blank" class="fallback-btn">üìÇ ‡§ó‡•Ç‡§ó‡§≤ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ ‡§´‡•ã‡§≤‡•ç‡§°‡§∞ ‡§ñ‡•ã‡§≤‡•á‡§Ç</a>
                </div>
            </div>
        `;

        els.prev.disabled = idx === 0;
        els.next.disabled = idx >= filtered.length - 1;
        els.jump.value = idx;
    }

    // --- PRINT PDF ---
    window.printAllData = function() {
        let html = `<div style="text-align:center;margin-bottom:30px"><h1>‡§™‡•ç‡§∞‡§µ‡§æ‡§∏ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h1><p>‡§ï‡•Å‡§≤ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ: ${filtered.length}</p></div>`;
        filtered.forEach(item => {
            const did = getDriveId(item.link);
            html += `<div class="p-card" style="page-break-inside:avoid; border:1px solid #ccc; padding:15px; margin-bottom:15px; display:flex;">
                <div style="flex:1">
                    <h3>${item.title}</h3>
                    <p>üìç ${item.district} | üìÖ ${item.date}</p>
                    <p>üë• ‡§â‡§™‡§∏‡•ç‡§•‡§ø‡§§‡§ø: <b>${item.count}</b></p>
                    <p>üé§ ‡§Ö‡§§‡§ø‡§•‡§ø: ${item.guests}</p>
                </div>
                ${did ? `<img src="https://lh3.googleusercontent.com/d/${did}=w200" style="width:150px;height:150px;object-fit:cover;border:1px solid #eee;">` : ''}
            </div>`;
        });
        els.print.innerHTML = html;
        window.print();
    }

    // --- Logic ---
    function applyFilters() {
        const s = els.search.value.toLowerCase();
        const d = els.dist.value;
        const dt = els.date.value;
        
        filtered = rawData.filter(i => {
            const textMatch = (i.title+i.guests+i.district).toLowerCase().includes(s);
            const distMatch = !d || i.district === d;
            // Date parsing for filter (YYYY-MM-DD)
            let dateMatch = true;
            if(dt) {
                // Convert sheet date (d/m/y) to comparable
                const p = i.date.split('/');
                if(p.length===3) {
                    const sheetDate = new Date(p[2], p[1]-1, p[0]).toISOString().split('T')[0];
                    dateMatch = sheetDate === dt;
                }
            }
            return textMatch && distMatch && dateMatch;
        });

        els.jump.innerHTML = "";
        filtered.forEach((item, i) => {
            const o = document.createElement("option"); o.value = i;
            o.textContent = `${i+1}. ${item.title.substring(0,30)}...`;
            els.jump.appendChild(o);
        });
        
        idx = 0; renderCurrent();
    }

    function initUI() {
        const dists = [...new Set(rawData.map(i => i.district))].sort();
        els.dist.innerHTML = '<option value="">üìç ‡§∏‡§≠‡•Ä ‡§ú‡§ø‡§≤‡•á (All)</option>';
        dists.forEach(d => {
            const o = document.createElement("option"); o.value = d; o.textContent = d;
            els.dist.appendChild(o);
        });
        applyFilters();
    }

    els.prev.onclick = () => { if(idx>0) { idx--; renderCurrent(); }};
    els.next.onclick = () => { if(idx<filtered.length-1) { idx++; renderCurrent(); }};
    els.jump.onchange = (e) => { idx = parseInt(e.target.value); renderCurrent(); };
    els.search.oninput = applyFilters;
    els.dist.onchange = applyFilters;
    els.date.onchange = applyFilters;

    fetchData();
</script>
</body>
</html>
