<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <title>कार्यक्रम घटनाएँ - लाइव डैशबोर्ड</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            background-color: #f9f9f9;
            font-family: Arial, sans-serif;
            color: #333;
        }
        .filter-container {
            text-align: center;
            margin: 20px;
            background-color: #ff9933; /* Saffron */
            padding: 10px;
            border-radius: 8px;
        }
        .slide {
            display: flex;
            flex-wrap: wrap;
            margin: 20px auto;
            max-width: 1200px;
            background-color: white;
            border: 2px solid #138808; /* Green */
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            page-break-after: always;
            min-height: 80vh;
        }
        .info {
            width: 50%;
            padding: 20px;
            background-color: #fff5e6;
            border-right: 1px solid #ccc;
        }
        .photos {
            width: 50%;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            justify-items: center;
            background-color: #e6ffe6;
            position: relative;
        }
        .img-thumb {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .limited .img-thumb:nth-child(n+5) {
            display: none;
        }
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 153, 51, 0.85);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            text-align: center;
        }
        h2 {
            color: #138808;
        }
        p {
            margin: 8px 0;
            font-size: 16px;
        }
        #downloadBtn {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #ff9933;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
        }
        #downloadBtn:hover {
            background-color: #e68a00;
        }
        @media print {
            .filter-container, #downloadBtn {
                display: none;
            }
            .slide {
                page-break-after: always;
            }
        }
        @media screen and (max-width: 768px) {
            .slide {
                flex-direction: column;
            }
            .info, .photos {
                width: 100%;
                border: none;
            }
            .photos {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="filter-container">
        <label for="districtFilter">जिला द्वारा फिल्टर करें:</label>
        <select id="districtFilter">
            <option value="all">सभी</option>
        </select>
    </div>
    <button id="downloadBtn" onclick="window.print()">PDF के रूप में डाउनलोड करें</button>
    <div id="slidesContainer"></div>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/1wyr0gt061UT5IVxT1JBYUEUJw1GYcBpzxDKEQmvcXXY/export?format=csv&gid=1839722438';

        async function fetchAndRenderData() {
            try {
                const response = await fetch(csvUrl);
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, { header: false, skipEmptyLines: true });
                const data = parsed.data;

                if (data.length < 1) return;

                const headers = data[0];
                const rows = data.slice(1);

                const districts = new Set();
                const slidesContainer = document.getElementById('slidesContainer');
                slidesContainer.innerHTML = '';

                rows.forEach(row => {
                    const entry = {};
                    headers.forEach((header, i) => {
                        entry[header.trim()] = (row[i] || '').trim();
                    });

                    const district = entry['जिला'] || 'अज्ञात';
                    districts.add(district);

                    const slide = document.createElement('div');
                    slide.className = 'slide';
                    slide.dataset.district = district;

                    const info = document.createElement('div');
                    info.className = 'info';
                    info.innerHTML = `
                        <h2>${entry['कार्यक्रम का नाम'] || 'N/A'}</h2>
                        <p><strong>दिनांक:</strong> ${entry['दिनांक'] || 'N/A'}</p>
                        <p><strong>जिला:</strong> ${district}</p>
                        <p><strong>कुल उपस्थिति:</strong> ${entry['कुल उपस्तिथि'] || 'N/A'}</p>
                        <p><strong>अतिथि/वक्ता:</strong> ${entry['अन्य वक्ता /अतिथि /पदाधिकारी'] || 'N/A'}</p>
                        <p><strong>टाइमस्टैम्प:</strong> ${entry['Timestamp'] || 'N/A'}</p>
                    `;

                    const photosDiv = document.createElement('div');
                    photosDiv.className = 'photos';

                    const photoText = entry['कार्यक्रम से सम्बंधित फोटो'] || '';
                    const photoLinks = photoText.split(',').map(l => l.trim()).filter(l => l);

                    photoLinks.forEach(link => {
                        const idMatch = link.match(/id=([^& ]+)/);
                        if (idMatch) {
                            const img = document.createElement('img');
                            img.className = 'img-thumb';
                            img.src = `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
                            img.alt = 'कार्यक्रम फोटो';
                            img.loading = 'lazy';
                            photosDiv.appendChild(img);
                        }
                    });

                    // Limit to 4 thumbnails + "See More" overlay on 4th if more
                    if (photoLinks.length > 4) {
                        photosDiv.classList.add('limited');
                        const thumbs = photosDiv.querySelectorAll('.img-thumb');
                        const fourthThumb = thumbs[3];
                        if (fourthThumb) {
                            fourthThumb.style.position = 'relative';
                            const overlay = document.createElement('div');
                            overlay.className = 'overlay';
                            overlay.innerHTML = `+${photoLinks.length - 4}<br>और देखें`;
                            overlay.onclick = function (e) {
                                e.preventDefault();
                                e.stopPropagation();
                                photosDiv.classList.remove('limited');
                                overlay.remove();
                            };
                            fourthThumb.appendChild(overlay);
                        }
                    }

                    slide.appendChild(info);
                    slide.appendChild(photosDiv);
                    slidesContainer.appendChild(slide);
                });

                // Populate district filter
                const filterSelect = document.getElementById('districtFilter');
                filterSelect.innerHTML = '<option value="all">सभी</option>';
                Array.from(districts).sort().forEach(dist => {
                    const opt = document.createElement('option');
                    opt.value = dist;
                    opt.textContent = dist;
                    filterSelect.appendChild(opt);
                });

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('slidesContainer').innerHTML = '<p>डेटा लोड करने में समस्या। स्प्रेडशीट पब्लिक है न?</p>';
            }
        }

        // Filter
        document.getElementById('districtFilter').addEventListener('change', function () {
            const value = this.value;
            document.querySelectorAll('.slide').forEach(slide => {
                slide.style.display = (value === 'all' || slide.dataset.district === value) ? 'flex' : 'none';
            });
        });

        // Load on start
        fetchAndRenderData();
    </script>
</body>
</html>
